---
title: "Mysql的一些思考"
date: 2024-11-12
categories: [MySQL]
tags: [MySQL,思考]
---


# 索引覆盖真的不需要回表吗？（MVCC）
## 什么是索引覆盖？
- 索引覆盖就是指在索引上存储了要查询的所有值，而不需要再访问数据表。

## MVCC
- MVCC（Multi-Version Concurrency Control）是MySQL中的一个并发控制机制，它允许多个事务同时对同一行进行读写操作，而不需要显式地锁定行。
- 基于 read view 和 undo log 实现
- MVCC的核心原理通过以下两个关键字段实现数据版本控制：
  - DB_TRX_ID：事务 ID，记录最后一次修改该行的事务 ID。
  - DB_ROLL_PTR：回滚指针，指向 undo log 的历史版本链。
- 这两个字段只保存在主键索引中


## 索引覆盖查询的 MVCC 处理

举例：
```sql
CREATE TABLE `user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `age` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`)
) ;
```
其中`id`是主键索引
`name`是二级索引


### 主键索引
```sql
select * from user where id = 1;
```

- 主键索引的叶子节点直接存储数据行，包含事务ID和回滚指针，可直接判断可见性


### 二级索引
```sql
select name from user where name = 'zhangsan';
```

- 二级索引的叶子节点存储的是索引列值 + 主键值
- 此时只查询了name，因为索引中已经包含了name信息，所以不需要回表，直接根据name查询主键索引即可

- 但是要判断数据的可见性，仍然要通过回表查询主键索引，来获取事务ID和回滚指针

> 索引覆盖减少了回表的数据量，但 MVCC 的可见性判断仍需依赖主键索引的版本信息。


## 既然都要回表,那么覆盖索引还有意义吗?
表 users 有 100 万行数据，执行以下查询：
```sql
-- 查询 1：无索引覆盖（需回表读取完整数据行）
SELECT * FROM users WHERE age = 25;  -- age 是二级索引

-- 查询 2：索引覆盖（需回表检查 MVCC）
SELECT id, age FROM users WHERE age = 25;  -- 联合索引 (age, id)
```
I/O 开销对比

| 操作           | 	查询 1（无覆盖）        | 	查询 2（有覆盖）      |
|--------------|-------------------|-----------------|
| 读取二级索引页数     | 	10 页（筛选 1000 行）	 | 10 页（筛选 1000 行） |
| 回表读取数据行页数	   | 1000 页（随机 I/O）    | 	0 页（无需数据列）     |
| 回表检查 MVCC 页数 | 	1000 页（主键元数据）	   | 1000 页（主键元数据）   |
| 总 I/O        | 	1010 页	          | 1010 页          |

看似总 I/O 相同，但关键差异：
- 查询 1：1000 次回表需读取完整数据行（可能触发磁盘随机 I/O）。
- 查询 2：1000 次回表仅读取主键元数据（可能全部命中缓存，无磁盘 I/O）。



- 无需读取完整数据行,主键索引的叶子节点虽然包含所有列，但 MVCC 检查只需读取事务 ID 和回滚指针，可能直接通过缓存（Buffer Pool）完成，无需触发磁盘 I/O。
- 传统回表需要读取完整数据行，若数据行包含大字段（如 TEXT、BLOB），可能触发多次 I/O。
> 索引覆盖在大多数场景下仍有重要意义，尤其是在需要减少数据访问量的查询中。MVCC 可见性检查的回表开销通常远小于全表扫描或回表读取完整数据行的开销。
